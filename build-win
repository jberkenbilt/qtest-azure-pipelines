#!/bin/bash
set -ex
wordsize=$1
tool=$2

config_args=""
if [ $wordsize == 32 -a $tool == mingw ]; then
    config_args="CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ LD=x86_64-w64-mingw32-ld AR=x86_64-w64-mingw32-ar RANLIB=x86_64-w64-mingw32-ranlib"
fi

cl
g++ -v
curl -L https://downloads.sourceforge.net/project/qpdf/external-libs/2017-08-21/qpdf-external-libs-bin.zip -o qpdf-external-libs-bin.zip
curl -L https://github.com/qpdf/qpdf/releases/download/release-qpdf-8.2.1/qpdf-8.2.1.tar.gz -o qpdf-8.2.1.tar.gz
tar xzf qpdf-8.2.1.tar.gz
cd qpdf-8.2.1
unzip ../qpdf-external-libs-bin.zip
cwd=`pwd`
PATH=$cwd/libqpdf/build:$PATH

rm -rf {install,qtest}-$tool$wordsize
# XXX show failed output instead of thing below
./config-$tool --with-windows-wordsize=$wordsize --enable-show-failed-test-output $config_args
make -j8
make -k check || \
    { mkdir qtest-$tool$wordsize; \
      tar cf - */build/qtest.log | (cd qtest-$tool$wordsize; tar xf -) }
make install
make distclean
