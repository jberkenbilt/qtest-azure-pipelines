#!/bin/bash
set -ex
wordsize=$1
tool=$2

choco install msys2
PATH="/c/msys64/usr/bin:$PATH"
if [ $wordsize == 64 ]; then
    pacman -S mingw-w64-x86_64-toolchain
    PATH=/c/msys64/mingw64/bin:$PATH
else
    pacman -S mingw-w64-i686-toolchain
    PATH=/c/msys64/mingw32/bin:$PATH
fi

cl
g++ -v
curl -L https://downloads.sourceforge.net/project/qpdf/external-libs/2017-08-21/qpdf-external-libs-bin.zip -o qpdf-external-libs-bin.zip
curl -L https://github.com/qpdf/qpdf/releases/download/release-qpdf-8.2.1/qpdf-8.2.1.tar.gz -o qpdf-8.2.1.tar.gz
tar xzf qpdf-8.2.1.tar.gz
cd qpdf-8.2.1
unzip ../qpdf-external-libs-bin.zip
cwd=`pwd`
PATH=$cwd/libqpdf/build:$PATH

rm -rf {install,qtest}-$tool$wordsize
# XXX show failed output instead of thing below
./config-$tool --with-windows-wordsize=$wordsize --enable-show-failed-test-output
make -j8
make -k check || \
    { mkdir qtest-$tool$wordsize; \
      tar cf - */build/qtest.log | (cd qtest-$tool$wordsize; tar xf -) }
make install
make distclean
